{% extends 'hub/base.html' %}

{% load humanize %}
{% load hub_filters %}
{% load static %}

{% block bodyclass %}js-area-page{% endblock %}

{% block script %}
    <script type="module" src="{% static 'js/home-out-esm.js' %}"></script>
    <script type="module" src="{% static 'js/area-out-esm.js' %}"></script>
{% endblock %}

{% block content %}

<div class="py-4 py-lg-5">
    <div class="container">
        <div class="d-flex flex-wrap align-items-start justify-content-between gap-3">
            <div>
                <h1 class="mb-2" id="area_name">{{ area.name }}</h1>
                {% if area_type == "WMC" %}
                <p class="mb-0 text-muted">Old parliamentary constituency</p>
                <p class="text-danger">This constituency no longer exists. Please select one of the replacement constituencies below</p>
                {% elif area_type == "WMC23" %}
                <p class="mb-0 text-muted">New parliamentary constituency</p>
                {% endif %}
            </div>

            <div>
                <button class="btn btn-primary d-flex align-items-center gap-2" data-bs-toggle="dropdown" aria-controls="sharing" aria-expanded="false">
                    {% include 'hub/includes/icons/share.html' %}
                    Share this page
                </button>
                <ul class="dropdown-menu shadow social-sharing-menu" id="sharing">
                    <li><a class="dropdown-item text-facebook-blue" href="https://www.facebook.com/sharer.php?u={{ request.build_absolute_uri|urlencode }}" target="_blank">
                        {% include 'hub/includes/icons/facebook.html' %}
                        Facebook
                    </a></li>
                    <li><a class="dropdown-item text-twitter-black" href="https://twitter.com/intent/tweet?url={{ request.build_absolute_uri|urlencode }}" target="_blank">
                        {% include 'hub/includes/icons/x.html' %}
                        X (Twitter)
                    </a></li>
                    <li><a class="dropdown-item text-threads-black" href="https://threads.net/intent/post?text={{ request.build_absolute_uri|urlencode }}" target="_blank">
                        {% include 'hub/includes/icons/threads.html' %}
                        Threads
                    </a></li>
                    <li><a class="dropdown-item text-linkedin-blue" href="https://www.linkedin.com/sharing/share-offsite/?url={{ request.build_absolute_uri|urlencode }}" target="_blank">
                        {% include 'hub/includes/icons/linkedin.html' %}
                        LinkedIn
                    </a></li>
                    <li><a class="dropdown-item text-whatsapp-green" href="https://api.whatsapp.com/send?text={{ request.build_absolute_uri|urlencode }}" target="_blank">
                        {% include 'hub/includes/icons/whatsapp.html' %}
                        WhatsApp
                    </a></li>
                    <li><button class="dropdown-item" data-copy-text="{{ request.build_absolute_uri }}" data-copy-success="Copied!">
                        {% include 'hub/includes/icons/link.html' %}
                        <span data-copy-feedback>Copy link</span>
                    </button></li>
                </ul>
            </div>
        </div>

      {% if area_type == "WMC" and area.overlaps %}
        <div style="max-width: 48rem;" class="mt-4 pt-lg-2">
          {% if overlap_constituencies|length > 1 %}
            <p class="text-muted">In June 2024, this constituency was replaced by <b>{{ overlap_constituencies|length|apnumber }} new constituenc{% if overlap_constituencies|length_is:1 %}y{% else %}ies{% endif %}:</b></p>
          {% else %}
            {% if overlap_unchanged %}
            <p class="text-muted">Looking for data on Prospective Parliamentary Candidates at the July general election?{% with overlap_constituencies|first as cons %} See the <a href="{% url 'area' area_type=cons.new_area.area_type.code name=cons.new_area.name %}">new constituency</a>.{% endwith %}</p>
            {% else %}
            <p class="text-muted">In June 2024, this constituency was replaced with:</p>
            {% endif %}
          {% endif %}
          {% if not overlap_unchanged %}
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(14rem, 1fr)); grid-gap: 1rem 2rem;">
              {% for overlap_constituency in overlap_constituencies %}
                <div>
                    <h3 class="h5"><a href="{% url 'area' area_type=overlap_constituency.new_area.area_type.code name=overlap_constituency.new_area.name %}" class="text-decoration-none">{{ overlap_constituency.new_area }}</a></h3>
                    <p class="fs-7 text-muted mb-0">Covers approximately {{ overlap_constituency.pop_overlap }}% of this old constituency’s population, and {{ overlap_constituency.area_overlap }}% of this old constituency’s area.</p>
                </div>
              {% endfor %}
            </div>
          {% endif %}
        </div>
      {% elif area_type == "WMC23" and area.overlaps %}
        <div style="max-width: 48rem;" class="mt-4 pt-lg-2">
          {% if overlap_constituencies|length > 1 %}
            <p class="text-muted">This constituency is new at the July general election, and replaces the previous <b>{{ overlap_constituencies|length|apnumber }} constituenc{% if overlap_constituencies|length_is:1 %}y{% else %}ies{% endif %}:</b></p>
          {% else %}
            {% if overlap_unchanged %}
            <p class="text-muted">Looking for data on this constituency’s former MP? {% with overlap_constituencies|first as cons %} See the <a href="{% url 'area' area_type=cons.old_area.area_type.code name=cons.old_area.name %}">old constituency</a>.{% endwith %}</p>
            {% else %}
            <p class="text-muted">This constituency is new at the July general election, and replaces:</p>
            {% endif %}
          {% endif %}
          {% if not overlap_unchanged %}
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(14rem, 1fr)); grid-gap: 1rem 2rem;">
              {% for overlap_constituency in overlap_constituencies %}
                <div>
                    <h3 class="h5"><a href="{% url 'area' area_type=overlap_constituency.old_area.area_type.code name=overlap_constituency.old_area.name %}" class="text-decoration-none">{{ overlap_constituency.old_area }}</a></h3>
                    <p class="fs-7 text-muted mb-0">Covered approximately {{ overlap_constituency.pop_overlap }}% of this new constituency’s population, and {{ overlap_constituency.area_overlap }}% of this new constituency’s area.</p>
                </div>
              {% endfor %}
            </div>
          {% endif %}
        </div>
      {% endif %}
    </div>
</div>

<div class="area-tabs">
    <div class="container">
        <ul class="nav nav-tabs">
            <li class="nav-item d-none js-nav-item-featured">
                <a class="nav-link" href="">Quick facts</a>
            </li>
          {% if user.is_authenticated %}
            <li class="nav-item d-none js-nav-item-favourites">
                <a class="nav-link" href="#favourites">
                    {% include 'hub/includes/icons/heart-empty.html' %}
                    Favourites
                </a>
            </li>
          {% endif %}
            {% if is_westminster_cons %}
              <li class="nav-item">
                  <a class="nav-link" href="#mp">MP</a>
              </li>
            {% endif %}
            <li class="nav-item">
                <a class="nav-link" href="#opinion">Public opinion</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#place">Place</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#movement">Movement</a>
            </li>
          </ul>
    </div>
</div>

<div class="py-4 py-lg-5 bg-light area-content">
    <div class="container mb-n3 mb-lg-n4">

        <aside class="area-data-favourites mb-5 mb-lg-6">
            <h2 class="h5 text-muted">Easy access to the datasets that matter to you</h2>
            <p class="d-flex flex-wrap align-items-center text-muted">Tap the {% include 'hub/includes/icons/heart-empty.html' %} icon on any dataset to add it to your {% include 'hub/includes/icons/heart-empty.html' %} Favourites tab.</p>
        </aside>

        {% if is_westminster_cons %}
        <section class="mb-5 mb-lg-6 area-section" id="mp">
            {% if no_mp %}
              <h2 class="text-primary">This constituency has no MP right now</h2>
              <p style="max-width: 37em;" class="mb-4">
                  There may be a <a href="https://en.wikipedia.org/wiki/List_of_United_Kingdom_by-elections_(2010%E2%80%93present)">by-election scheduled for this constituency</a>. Until then, this constituency has no sitting MP. Data for the previous MP is displayed below.
              </p>
            {% endif %}
            <div class="mb-3 d-sm-flex align-items-center">
              {% if no_mp %}
                <h2 class="mb-2 mb-sm-0 me-auto text-muted h4">Previous MP</h2>
              {% else %}
                <h2 class="mb-2 mb-sm-0 me-auto text-primary">MP</h2>
              {% endif %}
                <a href="https://www.writetothem.com" target="_blank" title="Opens in a new window" class="d-flex align-items-center js-email-your-mp">
                    Email your MP about this data
                    {% include 'hub/includes/icons/external-link.html' with classes="ms-2" %}
                </a>
            </div>
            <div class="area-data-grid">

                <div class="card dataset-card area-data--sm area-data--featured">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0">
                                {% include 'hub/includes/person-photo.html' with person=mp.person %}
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h3 class="h4 mb-0 text-primary" id="mp_name">{{ mp.person.name }}</h3>
                            {% if mp.person.party %}
                                <p class="mb-0 text-muted">{{ mp.person.party }}</p>
                            {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="card-footer">
                        <p class="card-text">
                          <a href="https://www.theyworkforyou.com/{% if mp.twfyid %}mp/{{ mp.twfyid}}{% endif %}">Data from TheyWorkForYou.</a>
                        </p>
                    </div>
                </div>

                <div class="card dataset-card area-data--md">
                    <div class="card-header">
                        <h3 class="h5">MP profiles</h3>
                    </div>
                    <div class="card-body">
                        <ul class="list-unstyled mb-0">
                          {% if mp.twitter %}
                            <li class="mb-2 text-truncate">Twitter: <a href="https://twitter.com/{{ mp.twitter }}">@{{ mp.twitter }}</a></li>
                          {% endif %}
                          {% if mp.facebook %}
                            <li class="mb-2 text-truncate">Facebook: <a href="https://facebook.com/{{ mp.facebook }}">/{{ mp.facebook }}</a></li>
                          {% endif %}
                          {% if mp.twfyid %}
                            <li class="mb-2 text-truncate"><a href="https://www.theyworkforyou.com/mp/{{ mp.twfyid}}">TheyWorkForYou voting record</a></li>
                          {% endif %}
                          {% if mp.parlid %}
                            <li class="mb-2 text-truncate"><a href="https://members.parliament.uk/member/{{ mp.parlid }}/contact">Parliament contact info</a></li>
                          {% endif %}
                          {% if mp.wikipedia %}
                            <li class="mb-2 text-truncate"><a href="{{ mp.wikipedia }}">Wikipedia page</a></li>
                          {% endif %}
                        </ul>
                    </div>
                    <div class="card-footer">
                        <p class="card-text">Data collated by The Climate Coalition.</p>
                    </div>
                </div>

              {% if not no_mp %}
                <div class="card dataset-card area-data--md area-data--featured">
                    <div class="card-header">
                        <h3 class="h5">Positions and memberships</h3>
                    </div>
                  {% if mp.job_titles or mp.cen_member or mp.nzsg_member or mp.select_committee_memberships or mp.appg_memberships %}
                    <div class="card-body">
                      {% if mp.job_titles %}
                        <h4 class="visually-hidden">Positions</h4>
                        <ul class="mb-3 mt-n2 list-unstyled lh-sm">
                          {% with mp.job_titles|splitlines as positions %}
                          {% for position in positions %}
                            <li class="mt-2">{{ position }}</li>
                          {% endfor %}
                          {% endwith %}
                        </ul>
                      {% endif %}
                      {% if mp.mp_standing_down_2024 == 'Standing Down' %}
                        <p>This MP will be standing down at the next election</p>
                      {% endif %}
                      {% if mp.cen_member or mp.nzsg_member %}
                        <h4 class="h6 text-muted fw-bold">Political groups</h4>
                        <ul class="tag-cloud">
                          {% if mp.cen_member %}
                            <li><a href="{% url 'explore' %}?{% urlencode_params cen_member__exact=True %}" class="tag" title="Show all constituencies with an MP in this group">Conservative Environment Network</a></li>
                          {% endif %}
                          {% if mp.nzsg_member %}
                            <li><a href="{% url 'explore' %}?{% urlencode_params nzsg_member__exact=True %}" class="tag" title="Show all constituencies with an MP in this group">Net Zero Scrutiny Group</a></li>
                          {% endif %}
                        </ul>
                      {% endif %}
                      {% if mp.select_committee_memberships %}
                        <h4 class="h6 text-muted fw-bold">Select committees</h4>
                        <ul class="tag-cloud">
                          {% for committee in mp.select_committee_memberships %}
                            <li><a href="{% url 'explore' %}?{% urlencode_params select_committee_membership__icontains=committee %}" class="tag" title="Show all constituencies with an MP in this select committee">{{ committee }}</a></li>
                          {% endfor %}
                        </ul>
                      {% endif %}
                      {% if mp.appg_memberships %}
                        <h4 class="h6 text-muted fw-bold">APPGs</h4>
                        <ul class="tag-cloud">
                          {% for appg in mp.appg_memberships %}
                            <li><a href="{% url 'explore' %}?{% urlencode_params mp_appg_memberships__exact=appg %}" class="tag" title="Show all constituencies with an MP in this APPG">{{ appg }}</a></li>
                          {% endfor %}
                        </ul>
                      {% endif %}
                    </div>
                    <div class="card-footer">
                        <p class="card-text">Data from <a href="https://www.parliament.uk/about/mps-and-lords/members/">UK Parliament</a>{% if mp.job_titles %} and <a href="http://www.mysociety.org">mySociety</a>{% endif %}.</p>
                    </div>
                    <div class="card-footer bg-yellow-100 fs-7 py-3">
                        <p class="mb-2">We’re currently working on collecting updated data on MP memberships.</p>
                        <p class="mb-0">You can <a href="#signup">sign up to be notified when we add it</a>.</p>
                    </div>
                  {% else %}
                    <div class="card-body text-muted fs-7">
                        <p class="mb-2">We’re currently working on collecting updated data on MP memberships.</p>
                        <p class="mb-0">You can <a href="#signup">sign up to be notified when we add it</a>.</p>
                    </div>
                  {% endif %}
                </div>

                <div class="card dataset-card area-data--md area-data--featured">
                    <div class="card-header">
                        <h3 class="h5">Votes and EDMs</h3>
                    </div>
                    <div class="card-body">
                        <table class="table mb-0">
                            <thead>
                                <tr>
                                    <th scope="col">Vote</th>
                                    <th scope="col">Position</th>
                                </tr>
                            </thead>
                            <tbody>
                              {% for vote in mp.votes %}
                                <tr>
                                    <td><a href="{{ vote.url }}">{{ vote.name }}</a></td>
                                    <td>{{ vote.vote }}</td>
                                </tr>
                              {% endfor %}
                              {% for item in mp.support %}
                                <tr>
                                    <td><a href="{{ item.url }}">{{ item.name }}</a></td>
                                    <td>{{ item.position }}</td>
                                </tr>
                              {% endfor %}
                            </tbody>
                        </table>
                   </div>
                   <div class="card-footer">
                       <p class="card-text">
                          Data from UK Parliament. Votes and EDMs selected for indicating support for climate/nature movement. 
                        {% if mp.twfyid %}
                          <a href="https://www.theyworkforyou.com/mp/{{ mp.twfyid }}">See this MP’s full voting record on TheyWorkForYou.</a>
                        {% endif %}
                        </p>
                   </div>
                </div>

                {% if mp.wrans %}
                <div class="card dataset-card area-data--md area-data--featured">
                    <div class="card-header">
                        <h3 class="h5">Written Answers</h3>
                    </div>
                    <div class="card-body">
                        <table class="table mb-0">
                            <thead>
                                <tr>
                                    <th scope="col">Department</th>
                                    <th scope="col">Topic</th>
                                    <th scope="col">Date</th>
                                </tr>
                            </thead>
                            <tbody>
                              {% for wran in mp.wrans %}
                                <tr>
                                    <td>{{ wran.department }}</td>
                                    <td>{{ wran.area }}</td>
                                    <td><a href="{{ wran.link }}">{{ wran.date }}</a></td>
                                </tr>
                              {% endfor %}
                            </tbody>
                        </table>
                   </div>
                   <div class="card-footer">
                       <p class="card-text">
                          Data from TheyWorkForYou. Recent Written Answers to questions submitted by the MP to departments relevant to climate and nature.
                        {% if mp.twfyid %}
                          <a href="https://www.theyworkforyou.com/mp/{{ mp.twfyid }}">See this MP’s full record on TheyWorkForYou.</a>
                        {% endif %}
                        </p>
                   </div>
                </div>
                {% endif %}
              {% endif %}

                <div class="card dataset-card area-data--sm {% comment %} TODO: dataset-card--favourite? {% endcomment %} area-data--featured">
                    <div class="card-header">
                        <h3 class="h5">{{ mp.mp_last_elected|date:"Y"}} majority</h3>
                        {% comment %} TODO: "Favourite" button {% endcomment %}
                    </div>
                    <div class="card-body">
                        <p class="card-text mb-0 display-6 lh-1 text-primary">
                            {{ mp.mp_election_majority|intcomma }}
                        </p>
                    </div>
                    <div class="card-footer">
                        <p class="card-text"><a href="https://members-api.parliament.uk/api/Members/{{ mp.parlid }}/LatestElectionResult">Data from UK Parliament.</a> This information is provided because in the UK electoral system, political parties and the media will be paying more attention to marginal seats and therefore the voices of the people within them can have greater national impact.</p>
                    </div>
                </div>
                <div class="card dataset-card area-data--sm {% comment %} TODO: dataset-card--favourite? {% endcomment %}">
                    <div class="card-header">
                        <h3 class="h5">Date elected</h3>
                        {% comment %} TODO: "Favourite" button {% endcomment %}
                    </div>
                    <div class="card-body">
                        <p class="card-text mb-0 display-6 lh-1 text-primary">
                            {{ mp.mp_first_elected|naturalday:"jS M Y" }}
                        </p>
                    </div>
                    <div class="card-footer">
                        <p class="card-text"><a href="https://members-api.parliament.uk/api/Members/{{ mp.parlid }}/LatestElectionResult">Data from UK Parliament.</a></p>
                    </div>
                </div>

              {% if no_mp and mp.person %}
                <div class="card dataset-card area-data--sm area-data--featured">
                    <div class="card-header">
                        <h3 class="h5">Term ended</h3>
                    </div>
                    <div class="card-body">
                        <p class="card-text mb-0 display-6 lh-1 text-primary">
                            {{ mp.person.end_date|naturalday:"jS M Y" }}
                        </p>
                    </div>
                    <div class="card-footer">
                        <p class="card-text"><a href="https://members-api.parliament.uk/api/Members/{{ mp.parlid }}/">Data from UK Parliament.</a></p>
                    </div>
                </div>
              {% endif %}

            </div>
            <div class="area-data-more">
                <a href="#mp">
                    More MP data
                    {% include "hub/includes/icons/chevron-right.html" %}
                </a>
            </div>
        </section>
        {% endif %}

        {% if categories.opinion %}
        <section class="mb-5 mb-lg-6 area-section" id="opinion">
            <h2 class="mb-3 text-primary">Public opinion</h2>
            <div class="area-data-grid">

              {% for dataset in categories.opinion %}
                {% if dataset.is_range and dataset.data|length > 9 %}
                <div class="card dataset-card area-data--lg {% if dataset.is_favourite or dataset.data.is_favourite %}dataset-card--favourite{% endif %} {% if dataset.featured %}area-data--featured{% endif %}">
                {% elif dataset.is_range and dataset.data|length > 2 or dataset.data_type == "json" %}
                <div class="card dataset-card area-data--md {% if dataset.is_favourite or dataset.data.is_favourite %}dataset-card--favourite{% endif %} {% if dataset.featured %}area-data--featured{% endif %}">
                {% else %}
                <div class="card dataset-card area-data--sm {% if dataset.is_favourite or dataset.data.is_favourite %}dataset-card--favourite{% endif %} {% if dataset.featured %}area-data--featured{% endif %}">
                {% endif %}
                    <div class="card-header">
                        <h3 class="h5">{{ dataset.label }}</h3>
                      {% if user.is_authenticated %}
                        {% include "hub/area/_favourite.html" with dataset=dataset %}
                      {% endif %}
                    </div>
                    <div class="card-body">
                      {% if dataset.data_type == "json" %}
                        {% include 'hub/area/_json_data.html' with dataset=dataset %}
                      {% elif dataset.data_type == "text" %}
                        <p class="card-text mb-0 display-6 lh-1 text-primary">{{ dataset.data.value|safe }}</p>
                      {% elif dataset.is_range and dataset.data|length > 0 %}
                        <table class="table mb-0 js-chart" data-chart-type="bar" data-chart-direction="y">
                          <thead>
                              <tr>
                                  <th scope="col"></th>
                                  <th scope="col" data-color="#068670">This area</th>
                                  <th scope="col" data-color="#ced4da">National average</th>
                              </tr>
                          </thead>
                          <tbody>
                            {% for row in dataset.data %}
                              <tr>
                                <th>{{ row.label }}</th>
                                <td>{{ row.value|floatformat }}%</td>
                                <td>{{ row.average|floatformat }}%</td>
                              </tr>
                              {% endfor %}
                          </tbody>
                        </table>
                      {% else %}
                        <p class="card-text mb-0 display-6 lh-1 text-primary">{{ dataset.data.value|floatformat }}%</p>
                        <p class="card-text mt-2 text-muted">{{dataset.data.average|floatformat }}% national average</p>
                      {% endif %}
                    </div>
                    <div class="card-footer">
                      <p class="card-text">
                          <a href="{{ dataset.source_url }}">{{ dataset.source_name }}</a>
                        {% if dataset.auto_conversion_disclaimer %}
                          <a href="{% url 'future_constituencies' %}">{{ dataset.auto_conversion_disclaimer|safe }}</a>
                        {% endif %}
                        {% if dataset.description %}
                          {{ dataset.description }}
                        {% endif %}
                        {% if dataset.release_date %}
                          Updated {{ dataset.release_date }}.
                        {% endif %}
                        {% if not dataset.is_public %}
                          <strong class="text-danger">Not to be publicly shared.</strong>
                        {% endif %}
                     </p>

                    </div>
                </div>
              {% endfor %}
            </div>

            <div class="area-data-more">
                <a href="#opinion">
                    More public opinion data
                    {% include "hub/includes/icons/chevron-right.html" %}
                </a>
            </div>
        </section>
        {% endif %}

        {% if categories.place %}
        <section class="mb-5 mb-lg-6 area-section" id="place">
            <h2 class="mb-3 text-primary">Place</h2>
            <div class="area-data-grid">

              {% for dataset in categories.place %}
                {% if dataset.is_range and dataset.data|length > 9 %}
                <div class="card dataset-card area-data--lg {% if dataset.is_favourite or dataset.data.is_favourite %}dataset-card--favourite{% endif %} {% if dataset.featured %} area-data--featured{% endif %}">
                {% elif dataset.related_category and dataset.related_category.is_range %}
                <div class="card dataset-card area-data--md {% if dataset.is_favourite or dataset.data.is_favourite %}dataset-card--favourite{% endif %} {% if dataset.featured %} area-data--featured{% endif %}">
                {% elif dataset.is_range or dataset.data_type == "json" %}
                <div class="card dataset-card area-data--md {% if dataset.is_favourite or dataset.data.is_favourite %}dataset-card--favourite{% endif %} {% if dataset.featured %} area-data--featured{% endif %}">
                {% else %}
                <div class="card dataset-card area-data--sm {% if dataset.is_favourite or dataset.data.is_favourite %}dataset-card--favourite{% endif %} {% if dataset.featured %} area-data--featured{% endif %}">
                {% endif %}
                    <div class="card-header">
                        <h3 class="h5">{{ dataset.label }}</h3>
                      {% if user.is_authenticated %}
                        {% include "hub/area/_favourite.html" with dataset=dataset %}
                      {% endif %}
                    </div>
                    <div class="card-body">
                      {% if dataset.data_type == "json" %}
                        {% include 'hub/area/_json_data.html' with dataset=dataset %}
                      {% elif dataset.data_type == "text" %}
                        <p class="card-text mb-0 display-6 lh-1 text-primary">{{ dataset.data.value|safe }}</p>
                      {% elif dataset.data_type == "url" %}
                        <a href="{{ dataset.data.value.url|safe }}" class="card-text lh-sm d-flex align-items-center">
                            {% include 'hub/includes/icons/document.html' with classes='flex-grow-0 flex-shrink-0 me-3' %}
                            <span>{{ dataset.data.value.link_text|safe }}</span>
                        </a>
                      {% elif dataset.data_type == "integer" %}
                        {% if dataset.subcategory == "date" %}
                          <p class="card-text mb-0 display-6 lh-1 text-primary">{{ dataset.data.value }}</p>
                        {% else %}
                          <p class="card-text mb-0 display-6 lh-1 text-primary">{{ dataset.data.value|intcomma }}</p>
                        {% endif %}
                        {% if dataset.data.average is not None %}
                          {% if dataset.subcategory == "date" %}
                            <p class="card-text mt-2 text-muted">{{dataset.data.average|floatformat:"0" }} national average</p>
                          {% else %}
                            <p class="card-text mt-2 text-muted">{{dataset.data.average|floatformat:"-1g" }} national average</p>
                          {% endif %}
                        {% endif %}
                        {% if dataset.related_category %}
                          {% include 'hub/area/_json_data.html' with dataset=dataset.related_category %}
                        {% endif %}
                      {% elif dataset.is_range and dataset.data|length > 0 %}
                          {% include 'hub/area/_range_data.html' with dataset=dataset %}
                      {% else %}
                        <p class="card-text mb-0 display-6 lh-1 text-primary">{{ dataset.data.value|floatformat }}%</p>
                        {% if dataset.data.average is not None %}
                        <p class="card-text mt-2 text-muted">{{dataset.data.average|floatformat }}% national average</p>
                        {% endif %}
                        {% if dataset.related_category and dataset.related_category.is_range %}
                          {% include 'hub/area/_range_data.html' with dataset=dataset.related_category %}
                        {% endif %}
                      {% endif %}
                    </div>
                    <div class="card-footer">
                      <p class="card-text">
                        {% if dataset.name.lower == "council climate action scorecard" %}
                          <a href="{{ dataset.source_url }}councils/{{ slug }}/">{{ dataset.source_name }}</a>
                        {% else %}
                          <a href="{{ dataset.source_url }}">{{ dataset.source_name }}</a>
                          {% endif %}
                        {% if dataset.auto_conversion_disclaimer %}
                          <a href="{% url 'future_constituencies' %}">{{ dataset.auto_conversion_disclaimer|safe }}</a>
                        {% endif %}
                        {% if dataset.description %}
                          {{ dataset.description }}
                        {% endif %}
                        {% if dataset.release_date %}
                          Updated {{ dataset.release_date }}.
                        {% endif %}
                        {% if not dataset.is_public %}
                          <strong class="text-danger">Not to be publicly shared.</strong>
                        {% endif %}
                      </p>

                    </div>
                </div>
              {% endfor %}
            </div>

            <div class="area-data-more">
                <a href="#place">
                    More place data
                    {% include "hub/includes/icons/chevron-right.html" %}
                </a>
            </div>
        </section>
        {% endif %}


        <section class="mb-5 mb-lg-6 area-section" id="movement">
            <h2 class="mb-3 text-primary">Movement</h2>
            <div class="area-data-grid">

              {% for dataset in categories.movement %}
                {% if dataset.is_range and dataset.data|length > 9 %}
                <div class="card dataset-card area-data--lg {% if dataset.is_favourite or dataset.data.is_favourite %}dataset-card--favourite{% endif %} {% if dataset.featured %}area-data--featured{% endif %}">
                {% elif dataset.is_range or dataset.data_type == "json" %}
                <div class="card dataset-card area-data--md {% if dataset.is_favourite or dataset.data.is_favourite %}dataset-card--favourite{% endif %} {% if dataset.featured %}area-data--featured{% endif %}">
                {% elif dataset.related_category and dataset.related_category.data.value|length > 6 %}
                <div class="card dataset-card area-data--md {% if dataset.is_favourite or dataset.data.is_favourite %}dataset-card--favourite{% endif %} {% if dataset.featured %}area-data--featured{% endif %}">
                {% else %}
                <div class="card dataset-card area-data--sm {% if dataset.is_favourite or dataset.data.is_favourite %}dataset-card--favourite{% endif %} {% if dataset.featured %}area-data--featured{% endif %}">
                {% endif %}
                    <div class="card-header">
                        <h3 class="h5">{{ dataset.label }}</h3>
                      {% if user.is_authenticated %}
                        {% include "hub/area/_favourite.html" with dataset=dataset %}
                      {% endif %}
                    </div>
                    <div class="card-body">
                      {% if dataset.data_type == "json" %}
                        {% include 'hub/area/_json_data.html' with dataset=dataset %}
                      {% elif dataset.data_type == "percentage" %}
                        <p class="card-text mb-0 display-6 lh-1 text-primary">{{ dataset.data.value|floatformat }}%</p>
                        <p class="card-text mt-2 text-muted">{{dataset.data.average|floatformat }}% national average</p>
                      {% elif dataset.data_type == "integer" %}
                        {% if dataset.related_category %}
                        <p class="card-text mb-3 display-6 lh-1 text-primary">{{ dataset.data.value|intcomma }}</p>
                        <ul class="tag-cloud">
                            {% if dataset.related_category.subcategory == "groups" %}
                              {% for data in dataset.related_category.data.sorted_groups %} 
                                {% if data.url %}
                                  <li><a href="{{ data.url }}" class="tag" title="{{ data.label }}">{{ data.group_name }}</a></li>
                                {% else %}
                                  <li class="tag">{{ data.group_name }}</li>
                                {% endif %}
                              {% endfor %}
                            {% else %}
                              {% for data in dataset.related_category.data.sorted_json %} 
                                {% if data.url %}
                                  <li><a href="{{ data.url }}" class="tag" title="{{ data.label }}">{{ data.name }}</a></li>
                                {% else %}
                                  <li class="tag">{{ data.name }}</li>
                                {% endif %}
                              {% endfor %}
                            {% endif %}
                        </ul>
                        {% else %}
                        <p class="card-text mb-0 display-6 lh-1 text-primary">{{ dataset.data.value|intcomma }}</p>
                        <p class="card-text mt-2 text-muted">{{dataset.data.average|floatformat:"-1g" }} national average</p>
                        {% endif %}
                      {% elif dataset.is_range %}
                        <table class="table mb-0">
                          <thead>
                              <tr>
                                  <th scope="col"></th>
                                  <th scope="col" data-color="#068670">This area</th>
                                  <th scope="col" data-color="#ced4da">National average</th>
                              </tr>
                          </thead>
                          <tbody>
                            {% for row in dataset.data %}
                              <tr>
                                <th>
                                  {{ row.label|html_format_dataset_name|safe }}
                                </th>
                                <td>{{ row.value|floatformat }}%</td>
                                <td>{{ row.average|floatformat }}%</td>
                              </tr>
                              {% endfor %}
                          </tbody>
                        </table>
                      {% else %}
                        <p class="card-text mb-0 display-6 lh-1 text-primary">{{ dataset.data.value|safe }}</p>
                      {% endif %}
                    </div>
                    <div class="card-footer">
                      <p class="card-text">
                          <a href="{{ dataset.source_url }}">{{ dataset.source_name }}</a>
                        {% if dataset.auto_conversion_disclaimer %}
                          <a href="{% url 'future_constituencies' %}">{{ dataset.auto_conversion_disclaimer|safe }}</a>
                        {% endif %}
                        {% if dataset.description %}
                          {{ dataset.description }}
                        {% endif %}
                        {% if dataset.release_date %}
                          Updated {{ dataset.release_date }}.
                        {% endif %}
                        {% if not dataset.is_public %}
                          <strong class="text-danger">Not to be publicly shared.</strong>
                        {% endif %}
                      </p>

                    </div>
                </div>
              {% endfor %}

            </div>
            <div class="area-data-more">
                <a href="#movement">
                    More movement data
                    {% include "hub/includes/icons/chevron-right.html" %}
                </a>
            </div>
        </section>

    </div>
</div>

<aside class="py-4 py-lg-5 bg-yellow-100 border-top d-print-none" id="signup">
    <div class="container">
        <div class="row">
          {% if not user.is_authenticated %}
            <div class="col-lg-5 me-lg-auto">
                <div class="d-flex align-items-center">
                    {% include 'hub/includes/icons/tcc-heart.html' with width="3em" height="3em" classes="me-3 me-lg-4 flex-shrink-0 flex-grow-0" %}
                    <div>
                        <h2 class="h4">Climate Coalition member?</h2>
                        <p class="mb-0"><a href="{% url 'login' %}">Sign in</a> or <a href="{% url 'signup' %}">request an account</a> to access exclusive members-only MRP and local movement data.</p>
                    </div>
                </div>
            </div>
          {% endif %}
            <div class="col-lg-6">
                {% include 'hub/includes/mailing-list-form.html' with classes="js-collapsable-mailing-list-form" %}
            </div>
        </div>
    </div>
</aside>

{% include 'hub/includes/feedback-modal.html' %}

{% endblock %}
