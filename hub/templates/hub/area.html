{% extends 'hub/base.html' %}

{% load humanize %}
{% load hub_filters %}

{% block bodyclass %}js-area-page{% endblock %}

{% block content %}

<div class="py-4 py-lg-5">
    <div class="container">
        <div class="d-flex flex-wrap align-items-start justify-content-between gap-3">
            <div>
                <h1 class="mb-2">{{ area.name }}</h1>
                {% if area_type == "WMC" %}
                <p class="mb-0 text-muted">Current parliamentary constituency</p>
                {% elif area_type == "WMC23" %}
                <p class="mb-0 text-muted">Future parliamentary constituency</p>
                {% endif %}
            </div>

            {% comment %} TODO: Make this share button work {% endcomment %}
            {% comment %} <button class="btn btn-primary d-flex align-items-center gap-2">
                {% include 'hub/includes/icons/share.html' %}
                Share this page
            </button> {% endcomment %}
        </div>

      {% if area_type == "WMC" and area.overlaps %}
        <div style="max-width: 48rem;" class="mt-4 pt-lg-2">
          {% if overlap_constituencies|length > 1 %}
            <p class="text-muted">At the next election, this constituency will be divided into <b>{{ overlap_constituencies|length|apnumber }} new constituenc{% if overlap_constituencies|length_is:1 %}y{% else %}ies{% endif %}:</b></p>
          {% else %}
            {% if overlap_unchanged %}
            <p class="text-muted">Looking for data on Prospective Parliamentary Candidates at the next general election?{% with overlap_constituencies|first as cons %} See the <a href="{% url 'area' area_type=cons.new_area.area_type.code name=cons.new_area.name %}">future constituency</a>.{% endwith %}</p>
            {% else %}
            <p class="text-muted">At the next election, this constituency will be replaced with:</p>
            {% endif %}
          {% endif %}
          {% if not overlap_unchanged %}
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(14rem, 1fr)); grid-gap: 1rem 2rem;">
              {% for overlap_constituency in overlap_constituencies %}
                <div>
                    <h3 class="h5"><a href="{% url 'area' area_type=overlap_constituency.new_area.area_type.code name=overlap_constituency.new_area.name %}" class="text-decoration-none">{{ overlap_constituency.new_area }}</a></h3>
                    <p class="fs-7 text-muted mb-0">Will cover approximately {{ overlap_constituency.pop_overlap }}% of this constituency’s population, and {{ overlap_constituency.area_overlap }}% of this constituency’s area.</p>
                </div>
              {% endfor %}
            </div>
          {% endif %}
        </div>
      {% elif area_type == "WMC23" and area.overlaps %}
        <div style="max-width: 48rem;" class="mt-4 pt-lg-2">
          {% if overlap_constituencies|length > 1 %}
            <p class="text-muted">This constituency will only exist at the next election, and replaces the previous <b>{{ overlap_constituencies|length|apnumber }} constituenc{% if overlap_constituencies|length_is:1 %}y{% else %}ies{% endif %}:</b></p>
          {% else %}
            {% if overlap_unchanged %}
            <p class="text-muted">Looking for data on this constituency’s current MP? {% with overlap_constituencies|first as cons %} See the <a href="{% url 'area' area_type=cons.old_area.area_type.code name=cons.old_area.name %}">current constituency</a>.{% endwith %}</p>
            {% else %}
            <p class="text-muted">This constituency will only exist at the next election, and replaces:</p>
            {% endif %}
          {% endif %}
          {% if not overlap_unchanged %}
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(14rem, 1fr)); grid-gap: 1rem 2rem;">
              {% for overlap_constituency in overlap_constituencies %}
                <div>
                    <h3 class="h5"><a href="{% url 'area' area_type=overlap_constituency.old_area.area_type.code name=overlap_constituency.old_area.name %}" class="text-decoration-none">{{ overlap_constituency.old_area }}</a></h3>
                    <p class="fs-7 text-muted mb-0">Will cover approximately {{ overlap_constituency.pop_overlap }}% of this constituency’s population, and {{ overlap_constituency.area_overlap }}% of this constituency’s area.</p>
                </div>
              {% endfor %}
            </div>
          {% endif %}
        </div>
      {% endif %}
    </div>
</div>

<div class="area-tabs">
    <div class="container">
        <ul class="nav nav-tabs">
            <li class="nav-item d-none js-nav-item-featured">
                <a class="nav-link" href="">Quick facts</a>
            </li>
            <li class="nav-item d-none js-nav-item-favourites">
                <a class="nav-link" href="#favourites">
                    {% include 'hub/includes/icons/heart-empty.html' %}
                    Favourites
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#mp">{% if area_type == "WMC23" %}PPCs{% else %}MP{% endif %}</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#opinion">Public opinion</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#place">Place</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#movement">Movement</a>
            </li>
          </ul>
    </div>
</div>

<div class="py-4 py-lg-5 bg-light area-content">
    <div class="container mb-n3 mb-lg-n4">

        <aside class="area-data-favourites mb-5 mb-lg-6">
            <h2 class="h5 text-muted">Easy access to the datasets that matter to you</h2>
            <p class="d-flex flex-wrap align-items-center text-muted">Tap the {% include 'hub/includes/icons/heart-empty.html' %} icon on any dataset to add it to your {% include 'hub/includes/icons/heart-empty.html' %} Favourites tab.</p>
        </aside>

        <section class="mb-5 mb-lg-6 area-section" id="mp">
            {% if area_type == "WMC" %}
            <h2 class="mb-3 text-primary">MP</h2>
            <div class="area-data-grid">

                <div class="card dataset-card area-data--sm area-data--featured">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0">
                                {% include 'hub/includes/person-photo.html' with person=mp.person %}
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h3 class="h4 mb-0 text-primary">{{ mp.person.name }}</h3>
                            {% if mp.party %}
                                <p class="mb-0 text-muted">{{ mp.party }}</p>
                            {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="card-footer">
                        <p class="card-text">
                            <a href="https://www.theyworkforyou.com/{% if mp.twfyid %}mp/{{ mp.twfyid}}{% endif %}">Data from TheyWorkForYou.</a>
                        </p>
                    </div>
                </div>

                <div class="card dataset-card area-data--md">
                    <div class="card-header">
                        <h3 class="h5">MP profiles</h3>
                    </div>
                    <div class="card-body">
                        <ul class="list-unstyled mb-0">
                          {% if mp.twitter %}
                            <li class="mb-2 text-truncate">Twitter: <a href="https://twitter.com/{{ mp.twitter }}">@{{ mp.twitter }}</a></li>
                          {% endif %}
                          {% if mp.facebook %}
                            <li class="mb-2 text-truncate">Facebook: <a href="https://facebook.com/{{ mp.facebook }}">/{{ mp.facebook }}</a></li>
                          {% endif %}
                          {% if mp.twfyid %}
                            <li class="mb-2 text-truncate"><a href="https://www.theyworkforyou.com/mp/{{ mp.twfyid}}">TheyWorkForYou voting record</a></li>
                          {% endif %}
                          {% if mp.parlid %}
                            <li class="mb-2 text-truncate"><a href="https://members.parliament.uk/member/{{ mp.parlid }}/contact">Parliament contact info</a></li>
                          {% endif %}
                          {% if mp.wikipedia %}
                            <li class="mb-2 text-truncate"><a href="{{ mp.wikipedia }}">Wikipedia page</a></li>
                          {% endif %}
                        </ul>
                    </div>
                    <div class="card-footer">
                        <p class="card-text"><a href="#">Data collated by The Climate Coalition</a></p>
                    </div>
                </div>

                <div class="card dataset-card area-data--md area-data--featured">
                    <div class="card-header">
                        <h3 class="h5">MP memberships</h3>
                    </div>
                    <div class="card-body">
                      {% if mp.cen_member or mp.nzsg_member %}
                        <h4 class="h6 text-muted fw-bold">Political groups</h4>
                        <ul class="tag-cloud">
                          {% if mp.cen_member %}
                            <li><a href="{% url 'explore' %}?{% urlencode_params cen_member__exact=True %}" class="tag" title="Show all constituencies with an MP in this group">Conservative Environment Network</a></li>
                          {% endif %}
                          {% if mp.nzsg_member %}
                            <li><a href="{% url 'explore' %}?{% urlencode_params nzsg_member__exact=True %}" class="tag" title="Show all constituencies with an MP in this group">Net Zero Scrutiny Group</a></li>
                          {% endif %}
                        </ul>
                      {% endif %}
                      {% if mp.select_committee_memberships %}
                        <h4 class="h6 text-muted fw-bold">Select committees</h4>
                        <ul class="tag-cloud">
                          {% for committee in mp.select_committee_memberships %}
                            <li><a href="{% url 'explore' %}?{% urlencode_params select_committee_membership__icontains=committee %}" class="tag" title="Show all constituencies with an MP in this select committee">{{ committee }}</a></li>
                          {% endfor %}
                        </ul>
                      {% endif %}
                      {% if mp.appg_memberships %}
                        <h4 class="h6 text-muted fw-bold">APPGs</h4>
                        <ul class="tag-cloud">
                          {% for appg in mp.appg_memberships %}
                            <li><a href="{% url 'explore' %}?{% urlencode_params mp_appg_memberships__exact=appg %}" class="tag" title="Show all constituencies with an MP in this APPG">{{ appg }}</a></li>
                          {% endfor %}
                        </ul>
                      {% endif %}
                    </div>
                    <div class="card-footer">
                        <p class="card-text">Data collated by The Climate Coalition.</p>
                    </div>
                </div>

                <div class="card dataset-card area-data--md area-data--featured">
                    <div class="card-header">
                        <h3 class="h5">Relevant votes &amp; amendments</h3>
                    </div>
                    <div class="card-body">
                        <table class="table mb-0">
                            <thead>
                                <tr>
                                    <th scope="col">Vote</th>
                                    <th scope="col">Position</th>
                                </tr>
                            </thead>
                            <tbody>
                              {% for vote in mp.votes %}
                                <tr>
                                    <td><a href="{{ vote.url }}">{{ vote.name }}</a></td>
                                    <td>{{ vote.vote }}</td>
                                </tr>
                              {% endfor %}
                              {% for item in mp.support %}
                                <tr>
                                    <td><a href="{{ item.url }}">{{ item.name }}</a></td>
                                    <td>{{ item.position }}</td>
                                </tr>
                              {% endfor %}
                            </tbody>
                        </table>
                   </div>
                   <div class="card-footer">
                       <p class="card-text">Data from UK Parliament.</p>
                   </div>
                </div>

                <div class="card dataset-card area-data--sm {% comment %} TODO: dataset-card--favourite? {% endcomment %} area-data--featured">
                    <div class="card-header">
                        <h3 class="h5">{{ mp.mp_last_elected|date:"Y"}} majority</h3>
                        {% comment %} TODO: "Favourite" button {% endcomment %}
                    </div>
                    <div class="card-body">
                        <p class="card-text mb-0 display-6 lh-1 text-primary">
                            {{ mp.mp_election_majority|intcomma }}
                        </p>
                    </div>
                    <div class="card-footer">
                        <p class="card-text"><a href="#">Data from UK Parliament.</a></p>
                    </div>
                </div>
                <div class="card dataset-card area-data--sm {% comment %} TODO: dataset-card--favourite? {% endcomment %}">
                    <div class="card-header">
                        <h3 class="h5">Date elected</h3>
                        {% comment %} TODO: "Favourite" button {% endcomment %}
                    </div>
                    <div class="card-body">
                        <p class="card-text mb-0 display-6 lh-1 text-primary">
                            {{ mp.mp_first_elected|naturalday:"jS M Y" }}
                        </p>
                    </div>
                    <div class="card-footer">
                        <p class="card-text"><a href="#">Data from UK Parliament.</a></p>
                    </div>
                </div>

            </div>
            <div class="area-data-more">
                <a href="#mp">
                    More MP data
                    {% include "hub/includes/icons/chevron-right.html" %}
                </a>
            </div>
            {% elif area_type == "WMC23" %}
            <h2 class="mb-3 text-primary">Prospective Parliamentary Candiates</h2>
            <div class="area-data-grid">
            {% for row in PPCs %}
              <div class="card dataset-card area-data--sm area-data--featured">
                  <div class="card-body">
                      <div class="d-flex align-items-center">
                          <div class="flex-shrink-0">
                              {% include 'hub/includes/person-photo.html' with person=row.person %}
                          </div>
                          <div class="flex-grow-1 ms-3">
                              <h3 class="h4 mb-0 text-primary">{{ row.person }}</h3>
                          {% if row.party %}
                              <p class="mb-0 text-muted">{{ row.party }}</p>
                          {% endif %}
                          </div>
                      </div>
                  </div>
                  <div class="card-footer">
                      <p class="card-text"><a href="https://whocanivotefor.co.uk/ppcs/">Data from Democracy Club.</a></p>
                  </div>
              </div>
            {% endfor %}
            {% endif %}
        </section>

        {% if categories.opinion %}
        <section class="mb-5 mb-lg-6 area-section" id="opinion">
            <h2 class="mb-3 text-primary">Public opinion</h2>
            <div class="area-data-grid">

              {% for dataset in categories.opinion %}
                {% if dataset.is_range and dataset.data|length > 9 %}
                <div class="card dataset-card area-data--lg {% if dataset.is_favourite or dataset.data.is_favourite %}dataset-card--favourite{% endif %} {% if dataset.featured %}area-data--featured{% endif %}">
                {% elif dataset.is_range and dataset.data|length > 2 or dataset.data_type == "json" %}
                <div class="card dataset-card area-data--md {% if dataset.is_favourite or dataset.data.is_favourite %}dataset-card--favourite{% endif %} {% if dataset.featured %}area-data--featured{% endif %}">
                {% else %}
                <div class="card dataset-card area-data--sm {% if dataset.is_favourite or dataset.data.is_favourite %}dataset-card--favourite{% endif %} {% if dataset.featured %}area-data--featured{% endif %}">
                {% endif %}
                    <div class="card-header">
                      <h3 class="h5">{{ dataset.label }}</h3>
                      {% include "hub/area/_favourite.html" with dataset=dataset %}
                    </div>
                    <div class="card-body">
                      {% if dataset.data_type == "json" %}
                      {% include 'hub/area/_json_data.html' with dataset=dataset %}
                      {% elif dataset.data_type == "text" %}
                        <p class="card-text mb-0 display-6 lh-1 text-primary">{{ dataset.data.value|safe }}</p>
                      {% elif dataset.is_range and dataset.data|length > 0 %}
                        <table class="table mb-0">
                          <thead>
                              <tr>
                                  <th scope="col">Answer</th>
                                  <th scope="col"></th>
                                  <th scope="col">National Average</th>
                              </tr>
                          </thead>
                          <tbody>
                            {% for row in dataset.data %}
                              <tr>
                                <th>{{ row.label }}</th>
                                <td>{{ row.value|floatformat }}%</td>
                                <td>{{ row.average|floatformat }}%</td>
                              </tr>
                              {% endfor %}
                          </tbody>
                        </table>
                      {% else %}
                        <p class="card-text mb-0 display-6 lh-1 text-primary">{{ dataset.data.value|floatformat }}%</p>
                        <p class="card-text mt-2 text-muted">{{dataset.data.average|floatformat }}% national average</p>
                      {% endif %}
                    </div>
                    <div class="card-footer">
                      <p class="card-text">
                          {{ dataset.source }}
                        {% if dataset.release_date %}
                          Updated {{ dataset.release_date }}.
                        {% endif %}
                      </p>
                    </div>
                </div>
              {% endfor %}
            </div>

            <div class="area-data-more">
                <a href="#opinion">
                    More public opinion data
                    {% include "hub/includes/icons/chevron-right.html" %}
                </a>
            </div>
        </section>
        {% endif %}

        {% if categories.place %}
        <section class="mb-5 mb-lg-6 area-section" id="place">
            <h2 class="mb-3 text-primary">Place</h2>
            <div class="area-data-grid">

              {% for dataset in categories.place %}
                {% if dataset.is_range and dataset.data|length > 9 %}
                <div class="card dataset-card area-data--lg {% if dataset.is_favourite or dataset.data.is_favourite %}dataset-card--favourite{% endif %} {% if dataset.featured %} area-data--featured{% endif %}">
                {% elif dataset.is_range or dataset.data_type == "json" %}
                <div class="card dataset-card area-data--md {% if dataset.is_favourite or dataset.data.is_favourite %}dataset-card--favourite{% endif %} {% if dataset.featured %} area-data--featured{% endif %}">
                {% else %}
                <div class="card dataset-card area-data--sm {% if dataset.is_favourite or dataset.data.is_favourite %}dataset-card--favourite{% endif %} {% if dataset.featured %} area-data--featured{% endif %}">
                {% endif %}
                    <div class="card-header">
                      <h3 class="h5">{{ dataset.label }}</h3>
                      {% include "hub/area/_favourite.html" with dataset=dataset %}
                    </div>
                    <div class="card-body">
                      {% if dataset.data_type == "json" %}
                      {% include 'hub/area/_json_data.html' with dataset=dataset %}
                      {% elif dataset.data_type == "text" %}
                        <p class="card-text mb-0 display-6 lh-1 text-primary">{{ dataset.data.value|safe }}</p>
                      {% elif dataset.data_type == "url" %}
                        <a href="{{ dataset.data.value.url|safe }}" class="card-text lh-sm d-flex align-items-center">
                            {% include 'hub/includes/icons/document.html' with classes='flex-grow-0 flex-shrink-0 me-3' %}
                            <span>{{ dataset.data.value.link_text|safe }}</span>
                        </a>
                      {% elif dataset.data_type == "integer" %}
                        <p class="card-text mb-0 display-6 lh-1 text-primary">{{ dataset.data.value }}</p>
                        {% if data.data.average %}
                        <p class="card-text mt-2 text-muted">{{dataset.data.average|floatformat }} national average</p>
                        {% endif %}
                      {% elif dataset.is_range and dataset.data|length > 0 %}
                        <table class="table mb-0">
                          <thead>
                              <tr>
                                  <th scope="col"></th>
                                  <th scope="col">This area</th>
                                  <th scope="col">UK Average</th>
                              </tr>
                          </thead>
                          <tbody>
                            {% for row in dataset.data %}
                              <tr>
                                <th>
                                  {{ row.label|html_format_dataset_name|safe }}
                                </th>
                                <td>{{ row.value|floatformat }}%</td>
                                <td>{{ row.average|floatformat }}%</td>
                              </tr>
                              {% endfor %}
                          </tbody>
                        </table>
                      {% else %}
                        <p class="card-text mb-0 display-6 lh-1 text-primary">{{ dataset.data.value|floatformat }}%</p>
                        <p class="card-text mt-2 text-muted">{{dataset.data.average|floatformat }}% national average</p>
                      {% endif %}
                    </div>
                    <div class="card-footer">
                      <p class="card-text">
                          {{ dataset.source }}
                        {% if dataset.release_date %}
                          Updated {{ dataset.release_date }}.
                        {% endif %}
                      </p>
                    </div>
                </div>
              {% endfor %}
            </div>

            <div class="area-data-more">
                <a href="#place">
                    More place data
                    {% include "hub/includes/icons/chevron-right.html" %}
                </a>
            </div>
        </section>
        {% endif %}


        <section class="mb-5 mb-lg-6 area-section" id="movement">
            <h2 class="mb-3 text-primary">Movement</h2>
            <div class="area-data-grid">

              {% for dataset in categories.movement %}
                {% if dataset.is_range and dataset.data|length > 9 %}
                <div class="card dataset-card area-data--lg {% if dataset.is_favourite or dataset.data.is_favourite %}dataset-card--favourite{% endif %} {% if dataset.featured %}area-data--featured{% endif %}">
                {% elif dataset.is_range or dataset.data_type == "json" %}
                <div class="card dataset-card area-data--md {% if dataset.is_favourite or dataset.data.is_favourite %}dataset-card--favourite{% endif %} {% if dataset.featured %}area-data--featured{% endif %}">
                {% elif dataset.related_category and dataset.related_category.data.value|length > 6 %}
                <div class="card dataset-card area-data--md {% if dataset.is_favourite or dataset.data.is_favourite %}dataset-card--favourite{% endif %} {% if dataset.featured %}area-data--featured{% endif %}">
                {% else %}
                <div class="card dataset-card area-data--sm {% if dataset.is_favourite or dataset.data.is_favourite %}dataset-card--favourite{% endif %} {% if dataset.featured %}area-data--featured{% endif %}">
                {% endif %}
                    <div class="card-header">
                      <h3 class="h5">{{ dataset.label }}</h3>
                      {% include "hub/area/_favourite.html" with dataset=dataset %}
                    </div>
                    <div class="card-body">
                      {% if dataset.data_type == "json" %}
                      {% include 'hub/area/_json_data.html' with dataset=dataset %}
                      {% elif dataset.data_type == "percentage" %}
                        <p class="card-text mb-0 display-6 lh-1 text-primary">{{ dataset.data.value|floatformat }}%</p>
                        <p class="card-text mt-2 text-muted">{{dataset.data.average|floatformat }}% national average</p>
                      {% elif dataset.data_type == "integer" %}
                        {% if dataset.related_category %}
                        <p class="card-text mb-3 display-6 lh-1 text-primary">{{ dataset.data.value }}</p>
                        <ul class="tag-cloud">
                            {% if dataset.related_category.subcategory == "groups" %}
                              {% for data in dataset.related_category.data.value %} 
                                {% if data.url %}
                                  <li><a href="{{ data.url }}" class="tag" title="{{ data.label }}">{{ data.group_name }}</a></li>
                                {% else %}
                                  <li class="tag">{{ data.group_name }}</li>
                                {% endif %}
                              {% endfor %}
                            {% else %}
                              {% for data in dataset.related_category.data.value %} 
                                {% if data.url %}
                                  <li><a href="{{ data.url }}" class="tag" title="{{ data.label }}">{{ data.name }}</a></li>
                                {% else %}
                                  <li class="tag">{{ data.name }}</li>
                                {% endif %}
                              {% endfor %}
                            {% endif %}
                        </ul>
                        {% else %}
                        <p class="card-text mb-0 display-6 lh-1 text-primary">{{ dataset.data.value }}</p>
                        <p class="card-text mt-2 text-muted">{{dataset.data.average|floatformat }} national average</p>
                        {% endif %}
                      {% elif dataset.is_range %}
                        <table class="table mb-0">
                          <thead>
                              <tr>
                                  <th scope="col"></th>
                                  <th scope="col">This area</th>
                                  <th scope="col">UK Average</th>
                              </tr>
                          </thead>
                          <tbody>
                            {% for row in dataset.data %}
                              <tr>
                                <th>
                                  {{ row.label|html_format_dataset_name|safe }}
                                </th>
                                <td>{{ row.value|floatformat }}%</td>
                                <td>{{ row.average|floatformat }}%</td>
                              </tr>
                              {% endfor %}
                          </tbody>
                        </table>
                      {% else %}
                        <p class="card-text mb-0 display-6 lh-1 text-primary">{{ dataset.data.value|safe }}</p>
                      {% endif %}
                    </div>
                    <div class="card-footer">
                      <p class="card-text">
                          {{ dataset.source }}
                        {% if dataset.release_date %}
                          Updated {{ dataset.release_date }}.
                        {% endif %}
                      </p>
                    </div>
                </div>
              {% endfor %}

            </div>
            <div class="area-data-more">
                <a href="#movement">
                    More movement data
                    {% include "hub/includes/icons/chevron-right.html" %}
                </a>
            </div>
        </section>

    </div>
</div>

{% endblock %}
